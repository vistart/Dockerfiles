sudo: required

services:
  - docker

language: python

python:
  - 3.7

matrix:
  include:
  - name: "CUDA 10.1 in ubuntu 18.04"
    env: BUILD_GROUP=cuda10.1-ubuntu18.04
  - name: "CUDA 10.0 in ubuntu 18.04"
    env: BUILD_GROUP=cuda10.0-ubuntu18.04
  - name: "CUDA 10.1 in ubuntu 16.04"
    env: BUILD_GROUP=cuda10.1-ubuntu16.04
  - name: "CUDA 10.0 in ubuntu 16.04"
    env: BUILD_GROUP=cuda10.0-ubuntu16.04
  allow_failures:
    - name: "CUDA 10.1 in ubuntu 18.04"

before_script:
  - pip install requests

script:
  - |
    if [ $BUILD_GROUP = 'cuda10.1-ubuntu18.04' ]; then
        python download_googledrive.py
        docker build cuda/ubuntu18.04/10.1/base -t vistart/cuda:10.1-base-ubuntu18.04
        docker build cuda/ubuntu18.04/10.1/runtime -t vistart/cuda:10.1-runtime-ubuntu18.04
        docker build cuda/ubuntu18.04/10.1/runtime/cudnn7 -t vistart/cuda:10.1-cudnn7-runtime-ubuntu18.04
        docker build cuda/ubuntu18.04/10.1/devel -t vistart/cuda:10.1-devel-ubuntu18.04
        docker build cuda/ubuntu18.04/10.1/devel/cudnn7 -t vistart/cuda:10.1-cudnn7-devel-ubuntu18.04
        docker build cuda/ubuntu18.04/10.1/devel/cudnn7/tensorrt6 -t vistart/cuda:10.1-cudnn7-tensorrt6-devel-ubuntu18.04
    elif [ $BUILD_GROUP = 'cuda10.0-ubuntu18.04' ]; then
        docker build cuda/ubuntu18.04/10.0/base -t vistart/cuda:10.0-base-ubuntu18.04
        docker build cuda/ubuntu18.04/10.0/runtime -t vistart/cuda:10.0-runtime-ubuntu18.04
        docker build cuda/ubuntu18.04/10.0/runtime/cudnn7 -t vistart/cuda:10.0-cudnn7-runtime-ubuntu18.04
        docker build cuda/ubuntu18.04/10.0/devel -t vistart/cuda:10.0-devel-ubuntu18.04
        docker build cuda/ubuntu18.04/10.0/devel/cudnn7 -t vistart/cuda:10.0-cudnn7-devel-ubuntu18.04
    elif [ $BUILD_GROUP = 'cuda10.1-ubuntu16.04' ]; then
        docker build cuda/ubuntu16.04/10.1/base -t vistart/cuda:10.1-base-ubuntu16.04
        docker build cuda/ubuntu16.04/10.1/runtime -t vistart/cuda:10.1-runtime-ubuntu16.04
        docker build cuda/ubuntu16.04/10.1/runtime/cudnn7 -t vistart/cuda:10.1-cudnn7-runtime-ubuntu16.04
        docker build cuda/ubuntu16.04/10.1/devel -t vistart/cuda:10.1-devel-ubuntu16.04
        docker build cuda/ubuntu16.04/10.1/devel/cudnn7 -t vistart/cuda:10.1-cudnn7-devel-ubuntu16.04
    elif [ $BUILD_GROUP = 'cuda10.0-ubuntu16.04' ]; then
        docker build cuda/ubuntu16.04/10.0/base -t vistart/cuda:10.0-base-ubuntu16.04
        docker build cuda/ubuntu16.04/10.0/runtime -t vistart/cuda:10.0-runtime-ubuntu16.04
        docker build cuda/ubuntu16.04/10.0/runtime/cudnn7 -t vistart/cuda:10.0-cudnn7-runtime-ubuntu16.04
        docker build cuda/ubuntu16.04/10.0/devel -t vistart/cuda:10.0-devel-ubuntu16.04
        docker build cuda/ubuntu16.04/10.0/devel/cudnn7 -t vistart/cuda:10.0-cudnn7-devel-ubuntu16.04
    fi

after_script:
- echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
- docker push vistart/cuda
